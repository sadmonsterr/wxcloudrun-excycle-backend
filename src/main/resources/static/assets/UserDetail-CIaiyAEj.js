import{u as de,A as he,a as xe,r as x,F as l,b as $,c as m,j as e,S as z,d as A,e as p,B as d,T as me,R as pe,C as U,I as j,f as T,g as B,h,i as C,D as o,k as je,l as g,m as ue,n as ye,o as ge,M as N,p as fe,q as Ie,P as be,s as Re}from"./index-CTY_xFTU.js";import{R as ve,a as we,b as O,f as M,g as Se,c as Ue,d as P}from"./storageService-C5wReweB.js";import{s as u}from"./shopService-CGNtv7O2.js";import{R as Ce}from"./ArrowLeftOutlined-C-ZLS4lo.js";import{D as Fe}from"./index-DPBXymSh.js";const{Title:ke,Text:a}=me,{Option:V}=h,De=t=>[{title:"商户ID",dataIndex:"shopId",key:"shopId",width:120,ellipsis:!0},{title:"商户名称",dataIndex:"shopName",key:"shopName",width:150},{title:"角色",dataIndex:"roleName",key:"roleName",width:120},{title:"操作",key:"action",width:100,render:(i,f)=>e.jsx(be,{title:"确定要删除这个用户角色关联吗？",onConfirm:()=>t(f),okText:"确定",cancelText:"取消",children:e.jsx(d,{type:"link",danger:!0,icon:e.jsx(Re,{}),children:"删除"})})}],Te=()=>{const{id:t}=de(),{message:i}=he.useApp(),f=xe(),[n,F]=x.useState(null),[q,k]=x.useState(!1),[I,b]=x.useState(!1),[H,R]=x.useState(!1),[y]=l.useForm(),[v]=l.useForm(),{data:s,loading:w,error:D,run:W}=$(async r=>{const c=await fe(r);if(c.businessLicense)try{const S=await P(c.businessLicense);F(S)}catch(S){console.error("File download URL error:",S)}return y.setFieldsValue({name:c.name,phone:c.phone,company:c.company,shop:c.shop,role:c.role,businessLicense:c.businessLicense}),c},{manual:!t,defaultParams:[t],onError:r=>{console.error("User detail error:",r)}}),{run:E}=m(u.getUserShopRolesByUserId,{manual:!0,onError:r=>{console.error("User shop roles fetch error:",r),i.error("获取用户商户角色列表失败")}}),{data:_={records:[],total:0,pages:0,current:1,size:10},run:K}=m(u.getRoles,{manual:!0,onError:r=>{console.error("Roles fetch error:",r),i.error("获取角色列表失败")}}),{run:G}=m(u.createUserShopRole,{manual:!0,onSuccess:()=>{R(!1),W(t),i.success("添加成功")},onError:r=>{i.error(`添加失败,${r.message}`)}}),{run:J}=m(u.deleteUserShopRoleByUserAndShop,{manual:!0,onSuccess:()=>{E(t),i.success("删除成功")},onError:r=>{i.error(`删除失败,${r.message}`)}}),{records:Q=[]}=_,{data:X={records:[],total:0,pages:0,current:1,size:10},run:Y}=m(u.getShops,{manual:!0,onError:r=>{console.error("Shops fetch error:",r),i.error("获取商户列表失败")}}),{records:Z=[]}=X,{loading:ee}=$(P,{manual:!0,onSuccess:r=>{F(r)},onError:r=>{console.error("File download URL error:",r)}});x.useEffect(()=>{t&&(E(t),K({page:1,size:100}),Y({page:1,size:100}))},[t]);const se=()=>{f("/users")},re=()=>{b(!0)},ne=()=>{b(!1),y.setFieldsValue({name:s==null?void 0:s.name,phone:s==null?void 0:s.phone,company:s==null?void 0:s.company,shop:s==null?void 0:s.shop,role:s==null?void 0:s.role,businessLicense:s==null?void 0:s.businessLicense})},le=async()=>{try{const r=await y.validateFields(),c={name:r.name,phone:r.phone,company:r.company,shop:r.shop,role:r.role,businessLicense:r.businessLicense};await Ie(t,c),i.success("用户更新成功"),b(!1)}catch(r){console.error("Save error:",r),i.error("保存失败，请重试")}},ae=()=>{if(n!=null&&n.downloadUrl){const r=document.createElement("a");r.href=n.downloadUrl,r.download=n.fileName||"business_license",document.body.appendChild(r),r.click(),document.body.removeChild(r)}},L=()=>{n!=null&&n.downloadUrl&&k(!0)},oe=()=>{k(!1)},te=()=>{v.resetFields(),R(!0)},ie=async()=>{try{const r=await v.validateFields();await G({...r,userId:t})}catch{i.error("操作失败")}},ce=async r=>{J(r.userId,r.shopId)};return w?e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px"},children:e.jsx(z,{size:"large"})}):D?e.jsx(A,{message:D,type:"error",showIcon:!0,style:{margin:"24px"}}):s?e.jsxs("div",{style:{padding:"0 0 24px 0"},children:[e.jsxs("div",{style:{marginBottom:24,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(p,{children:[e.jsx(d,{type:"text",icon:e.jsx(Ce,{}),onClick:se,children:"返回用户列表"}),e.jsx(Fe,{type:"vertical"}),e.jsx(ke,{level:2,style:{margin:0},children:"用户详情"})]}),I?e.jsxs(p,{children:[e.jsx(d,{type:"default",icon:e.jsx(ve,{}),onClick:ne,children:"取消"}),e.jsx(d,{type:"primary",icon:e.jsx(we,{}),onClick:le,children:"保存"})]}):e.jsx(d,{type:"primary",icon:e.jsx(pe,{}),onClick:re,children:"编辑用户"})]}),e.jsx(U,{title:"基本信息",style:{marginBottom:24},children:I?e.jsxs(l,{form:y,layout:"vertical",children:[e.jsx(l.Item,{label:"用户ID",children:e.jsx(a,{code:!0,children:s==null?void 0:s.id})}),e.jsx(l.Item,{name:"name",label:e.jsxs("span",{children:[e.jsx(T,{style:{marginRight:4}}),"姓名"]}),rules:[{required:!0,message:"请输入姓名"}],children:e.jsx(j,{placeholder:"请输入姓名"})}),e.jsx(l.Item,{name:"phone",label:e.jsxs("span",{children:[e.jsx(B,{style:{marginRight:4}}),"手机号"]}),rules:[{required:!0,message:"请输入手机号"}],children:e.jsx(j,{placeholder:"请输入手机号"})}),e.jsx(l.Item,{name:"company",label:"公司",children:e.jsx(j,{placeholder:"请输入公司名称"})}),e.jsx(l.Item,{name:"shop",label:"门店",children:e.jsx(j,{placeholder:"请输入门店名称"})}),e.jsx(l.Item,{name:"role",label:"职位",children:e.jsxs(h,{placeholder:"请选择职位",children:[e.jsx(h.Option,{value:"boss",children:"老板"}),e.jsx(h.Option,{value:"manager",children:"店长"}),e.jsx(h.Option,{value:"staff",children:"店员"}),e.jsx(h.Option,{value:"driver",children:"司机"})]})}),e.jsx(l.Item,{name:"businessLicense",label:e.jsxs("span",{children:[e.jsx(O,{style:{marginRight:4}}),"营业执照"]}),children:e.jsx(j,{placeholder:"请输入营业执照文件路径"})}),e.jsx(l.Item,{label:"用户状态",children:e.jsx(C,{color:"success",children:"正常"})})]}):e.jsxs(o,{column:2,bordered:!0,children:[e.jsx(o.Item,{label:"用户ID",span:2,children:e.jsx(a,{code:!0,children:s==null?void 0:s.id})}),e.jsx(o.Item,{label:e.jsxs("span",{children:[e.jsx(T,{style:{marginRight:4}}),"姓名"]}),children:e.jsx(a,{strong:!0,children:(s==null?void 0:s.name)||"未设置"})}),e.jsx(o.Item,{label:e.jsxs("span",{children:[e.jsx(B,{style:{marginRight:4}}),"手机号"]}),children:e.jsx(a,{strong:!0,children:(s==null?void 0:s.phone)||"未设置"})}),e.jsx(o.Item,{label:"公司",children:e.jsx(a,{strong:!0,children:(s==null?void 0:s.company)||"未设置"})}),e.jsx(o.Item,{label:"门店",children:e.jsx(a,{strong:!0,children:(s==null?void 0:s.shop)||"未设置"})}),e.jsx(o.Item,{label:"职位",children:e.jsx(C,{color:"purple",children:(s==null?void 0:s.roleName)||(s==null?void 0:s.role)||"未设置"})}),e.jsx(o.Item,{label:e.jsxs("span",{children:[e.jsx(O,{style:{marginRight:4}}),"营业执照"]}),children:s!=null&&s.businessLicense?e.jsx("div",{children:e.jsx(p,{direction:"vertical",size:"small",children:ee?e.jsx(z,{size:"small"}):n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx(a,{strong:!0,children:n.fileName}),e.jsx("br",{}),e.jsxs(a,{type:"secondary",children:[M(n.fileSize)," • ",n.fileType.toUpperCase()]})]}),Se(n.fileName)==="image"&&e.jsx("div",{children:e.jsx("img",{src:n.downloadUrl,alt:"营业执照",style:{maxWidth:"200px",maxHeight:"150px",border:"1px solid #d9d9d9",borderRadius:"4px",cursor:"pointer"},onClick:L})}),e.jsxs(p,{children:[e.jsx(d,{type:"primary",size:"small",icon:e.jsx(je,{}),onClick:L,children:"预览"}),e.jsx(d,{type:"default",size:"small",icon:e.jsx(Ue,{}),onClick:ae,children:"下载"})]})]}):e.jsx(a,{type:"warning",children:"无法获取文件信息"})})}):e.jsx(a,{type:"secondary",children:"未上传"})}),e.jsx(o.Item,{label:"用户状态",children:e.jsx(C,{color:"success",children:"正常"})})]})}),e.jsx(U,{title:"时间信息",children:I?e.jsxs(l,{children:[e.jsx(l.Item,{label:e.jsxs("span",{children:[e.jsx(g,{style:{marginRight:4}}),"创建时间"]}),children:e.jsx(a,{code:!0,children:s==null?void 0:s.createdAt})}),e.jsx(l.Item,{label:e.jsxs("span",{children:[e.jsx(g,{style:{marginRight:4}}),"更新时间"]}),children:e.jsx(a,{code:!0,children:s==null?void 0:s.updatedAt})})]}):e.jsxs(o,{column:2,bordered:!0,children:[e.jsx(o.Item,{label:e.jsxs("span",{children:[e.jsx(g,{style:{marginRight:4}}),"创建时间"]}),children:e.jsx(a,{children:s==null?void 0:s.createdAt})}),e.jsx(o.Item,{label:e.jsxs("span",{children:[e.jsx(g,{style:{marginRight:4}}),"更新时间"]}),children:e.jsx(a,{children:s==null?void 0:s.updatedAt})})]})}),e.jsxs(U,{title:e.jsxs("span",{children:[e.jsx(ge,{style:{marginRight:4}}),"商户角色管理"]}),style:{marginBottom:24},children:[e.jsx("div",{style:{marginBottom:16},children:e.jsx(d,{type:"primary",icon:e.jsx(ue,{}),onClick:te,children:"添加商户角色"})}),e.jsx(ye,{columns:De(ce),dataSource:s.shopRoles,rowKey:"id",loading:w,pagination:!1,bordered:!0})]}),e.jsx(N,{title:"营业执照预览",open:q,onCancel:oe,footer:null,width:800,centered:!0,destroyOnClose:!0,children:(n==null?void 0:n.downloadUrl)&&e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("img",{src:n.downloadUrl,alt:"营业执照预览",style:{maxWidth:"100%",maxHeight:"600px",objectFit:"contain"}}),e.jsx("div",{style:{marginTop:16},children:e.jsxs(p,{children:[e.jsx(a,{strong:!0,children:n.fileName}),e.jsxs(a,{type:"secondary",children:[M(n.fileSize)," • ",n.fileType.toUpperCase()]})]})})]})}),e.jsx(N,{title:"添加商户角色",open:H,onOk:ie,onCancel:()=>R(!1),confirmLoading:w,children:e.jsxs(l,{form:v,layout:"vertical",children:[e.jsx(l.Item,{label:"商户",name:"shopId",rules:[{required:!0,message:"请选择商户"}],children:e.jsx(h,{placeholder:"请选择商户",children:Z.map(r=>e.jsx(V,{value:r.shopId,children:r.name},r.shopId))})}),e.jsx(l.Item,{label:"角色",name:"roleId",rules:[{required:!0,message:"请选择角色"}],children:e.jsx(h,{placeholder:"请选择角色",children:Q.map(r=>e.jsx(V,{value:r.roleId,children:r.name},r.roleId))})})]})})]}):e.jsx(A,{message:"用户不存在",type:"warning",showIcon:!0,style:{margin:"24px"}})};export{Te as default};
